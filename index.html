<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>Million on Mars Land Rush ROI Calculator</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="js-yaml.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">

</head>
<body>

  <div id="app">
    <v-app>
      <v-main>
    
     <p class="text-center">
    This tool calculates the Dusk gain of various <a href="https://www.milliononmars.com/">Million on Mars</a> tasks. This is EXPERIMENTAL, do your own calculations before making major decisions!
</p>
    
    <v-container>
      <v-row>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="buy_price" label="Buy Price" v-on:change="changeSelect" v-model="selected_buy_price"></v-select>
          <v-tooltip bottom>
            <template v-slot:activator="{ on, attrs }">
              <v-icon v-bind="attrs" v-on="on" small>
                mdi-help-circle-outline
              </v-icon>
            </template>
            <span>
                  <b>Price of resources to calculate build cost</b><br>
                  <b>Last Sold</b> - Last sale price on market<br>
                  <b>24H Avg</b> - Average of last 24hrs of sales<br>
                  <b>Split</b> - Halfway between Last Sold and 24H Avg<br>
                  <b>Lower</b> - Either Last Sold or 24H Avg, whichever is lower<br>
                  <b>Higher</b> - Either Last Sold or 24H Avg, whichever is higher<br>
            </span>
          </v-tooltip>
        </v-col>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="sell_price" label="Sell Price" v-on:change="changeSelect" v-model="selected_sell_price"></v-select>
          <v-tooltip bottom>
            <template v-slot:activator="{ on, attrs }">
              <v-icon dark v-bind="attrs" v-on="on" small>
                mdi-help-circle-outline
              </v-icon>
            </template>
            <span>
                  <b>Sale price of resources generated by tasks</b><br>
                  <b>Last Sold</b> - Last sale price on market<br>
                  <b>24H Avg</b> - Average of last 24hrs of sales<br>
                  <b>Split</b> - Halfway between Last Sold and 24H Avg<br>
                  <b>Lower</b> - Either Last Sold or 24H Avg, whichever is lower<br>
                  <b>Higher</b> - Either Last Sold or 24H Avg, whichever is higher<br>
            </span>
          </v-tooltip>
        </v-col>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="power_source" label="Power Source" v-on:change="changeSelect" v-model="selected_power_source"></v-select>
          <v-tooltip bottom>
            <template v-slot:activator="{ on, attrs }">
              <v-icon
                dark
                v-bind="attrs"
                v-on="on"
                small
              >
                mdi-help-circle-outline
              </v-icon>
            </template>
            <span>
                  <b>Cost of Power used in calculations</b><br>
                  <b>Market Price</b> - Cost of buying Full Power Cell and selling Empty Cell<br>
                  <b>Charge Power Cell</b> - Stamina cost of charging a Power cell<br>
                  <b>Charge Power Cell III</b> - Stamina cost of charging a Power cells 3-for-2<br>
            </span>
        </v-col>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="stamina_source" label="Stamina Source" v-on:change="changeSelect" v-model="selected_stamina_source"></v-select>
        </v-col>
      </v-row>
      <v-row :class="{red:market_time_warning}" class="text-right" align-right>
        <v-col class="text-right" cols="24" sm="12">
          Market data {{ market_timetext }}
        </v-col>
      </v-row>
    </v-container>
         
         
    
    <v-data-table :headers="headers" :items="resources" :items-per-page="-1" class="elevation-1" :custom-sort="customSort" dark>
      <template v-slot:item.name="{ item }">
        <img v-bind:src="item.icon" height="24" style="margin-right: 6px; vertical-align:middle"/>{{ item.name }}
      </template>
      <template v-slot:item.cost="props">
          <v-edit-dialog
            :return-value.sync="props.item.cost"
            @save="save"
            @cancel="cancel"
            @open="open"
            @close="close"
            color="red"
          >
            {{ props.item.cost }}
            <template v-slot:input>
              <v-list dense color="grey darken-3" rounded>
                <v-list-item-title><b>{{props.item.name}}</b> : <span style="color: #c17e1f; font-weight: bold">{{ props.item.cost }}</span></v-list-item-title>
                <v-divider></v-divider>
                <template v-for="(line, index) in props.item.cost_breakdown">
                    <v-list-item-content>
                    {{ line.resource }} :  {{ line.cost }}
                    </v-list-item-content>
                </template>
          </v-card>
            </template>
          </v-edit-dialog>
      </template>
      <template v-slot:item.gain="{ item }">
          <div v-html="item.gain"></div> 
      </template>
      <template v-slot:item.roi="{ item }">
        <v-chip :color="getColor(item.roi)">
          {{ item.roi }}%
        </v-chip>
      </template>
    </v-data-table>

<p></p>

  <p><img src="images/AbacusMonkey.png" width="64" style="float: left; margin-left: 1em; margin-right: 1em"> Created by digipedro. Images are Copyright Million on Mars Inc.<br/>Donations of WAX can be sent to <b>iamdigipedro</b><br/>Donations of BANANO can be sent to
	<a href="https://creeper.banano.cc/explorer/account/ban_3d6pzryts53tzk1u87yobfcrcwuiq11hhpj7oo8mapnodpkroc7dkqq8z8hc/history">
	ban_3d6pzryts53tzk1u87yobfcrcwuiq11hhpj7oo8mapnodpkroc7dkqq8z8hc
	</a>

      </v-main>
    </v-app>
  </div>



  <script>
      
	  var vv = new Vue({
	    el: '#app',
		mounted:function() {
            this.loadYAML();
            this.loadMarket();
            setInterval(function() { this.updateTimer() }.bind(this), 30 * 1000 );
		},
	    vuetify: new Vuetify({
            theme: { dark: true },
        }),
	    data: {
            odata: {},
            market: {},
            sources_loaded: 0,
            sources_to_load: 2,
            buy_price: ['Last Sold', '24H Avg', 'Split', 'Lower', 'Higher'],
            selected_buy_price: 'Higher',
            sell_price: ['Last Sold', '24H Avg', 'Split', 'Lower', 'Higher'],
            selected_sell_price: 'Lower',
            power_source: ['Market Price', 'Charge Power Cell', 'Charge Power Cell III'],
            selected_power_source: 'Charge Power Cell',
            stamina_source: ['Eat Snack', 'Eat Meal', 'Eat Feast', 'Drink Coffee', 'Job'],
            selected_stamina_source: 'Eat Meal',
            market_timestamp: 0,
            market_timetext: 'Loading...',
            market_time_warning: false,
            
            headers: [
              { text: 'Name', align: 'start', value: 'name' },
              { text: 'Build Cost', value: 'cost' },
              { text: 'Sale Value', value: 'sale' },
              { text: 'Gain (After Fees)', value: 'gain' },
              { text: 'ROI (After Fees)', value: 'roi' },
            ],
            resources: [],
	    },
        filters: {
            localnum: function (value) {
                return value.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 })
            }
        },
	    methods: {
            save () {
                // re-calc
            },
            cancel () { },
            open () { },
            close () { },
            customSort(items, index, isDesc) {
                items.sort((a, b) => {
                  if (isDesc[0]) {
                    return parseFloat(a[index]) < parseFloat(b[index]) ? -1 : 1;
                  } else {
                    return parseFloat(a[index]) > parseFloat(b[index]) ? -1 : 1;
                  }
                });
                return items;
            },
            changeSelect(id) {
                this.buildTable();
            },
            updateTimer() {
                if (this.market_timestamp == 0)
                    return;
                let tdiff = ((new Date()).getTime() - this.market_timestamp.getTime()) / 1000;
                if (tdiff < 60)
                    this.market_timetext = "updated < 1 min ago";
                else if (tdiff < 3600)
                    this.market_timetext = "updated " + Math.round(tdiff / 60) + " mins ago";
                else if (tdiff < 5400)
                    this.market_timetext = "updated 1 hour ago";
                else
                    this.market_timetext = "updated " + Math.round(tdiff / 3600) + " hours ago"
                this.market_time_warning = (tdiff > 5400);
            },
            getSaleValue(id) {
                let sale = [0, 0, 0]
                for (const [key, value] of Object.entries(this.odata.recipies[id].output)) {
                    if (Array.isArray(value)) {
                        sale[0] += this.getPrice(key, this.selected_sell_price) * value[0];
                        sale[1] += this.getPrice(key, this.selected_sell_price) * value[1];
                        sale[2] += this.getPrice(key, this.selected_sell_price) * value[2];
                    } else {
                        sale[0] += this.getPrice(key, this.selected_sell_price) * value;
                        sale[1] += this.getPrice(key, this.selected_sell_price) * value;
                        sale[2] += this.getPrice(key, this.selected_sell_price) * value;
                    }
                }
                return sale;
            },
            getPrice(id, type = 'Split') {
                // In future handle price type selection
                                
                if (id == 'power') {
                    if (this.selected_power_source == 'Market Price')
                        return ((this.getPrice('full_pc', this.selected_buy_price) - this.getPrice('empty_pc', this.selected_sell_price)) / 20);
                    if (this.selected_power_source == 'Charge Power Cell III')
                        return (2/60);
                    // 'Charge Power Cell'
                    return (1/20);
                }
                if (id == 'stamina') {
                    let food = this.getPrice('food', this.selected_buy_price);
                    let water = this.getPrice('water', this.selected_buy_price);
                    let waste = this.getPrice('waste', this.selected_sell_price);
                    if (this.selected_stamina_source == 'Eat Snack')
                        return (30 * food + 10 * water - 2 * waste) / 16;
                    if (this.selected_stamina_source == 'Eat Feast')
                        return (90 * food + 30 * water - 6 * waste) / 32;
                    if (this.selected_stamina_source == 'Drink Coffee')
                        return this.getPrice('coffee_brewed', this.selected_buy_price) / 8;
                    if (this.selected_stamina_source == 'Job')
                        return 1.04;
                    // 'Eat Meal'
                    return (60 * food + 20 * water - 4 * waste) / 24;
                }
                if (id == 'dusk') {
                    return 1
                }
                for (let i = 0; i < this.market.length; i++) {
                    if (this.market[i].id == id) {
                        if (type == 'Last Sold')
                            return this.market[i].attributes.lastSoldPrice
                        if (type == '24H Avg')
                            return this.market[i].attributes.averageDaySoldPrice
                        if (type == 'Split')
                            return ((this.market[i].attributes.lastSoldPrice + this.market[i].attributes.averageDaySoldPrice) / 2);
                        if (type == 'Lower')
                            return Math.min(this.market[i].attributes.lastSoldPrice, this.market[i].attributes.averageDaySoldPrice);
                        if (type == 'Higher')
                            return Math.max(this.market[i].attributes.lastSoldPrice, this.market[i].attributes.averageDaySoldPrice);
                    }
                }
                return 0;
            },
            resource_name(id) {
                return this.odata.resources[id].display_name
            },
            buildTable(first_time = false) {
                for (const [key, value] of Object.entries(this.odata.recipies)) {
                    let cost = 0;
                    let cost_breakdown = [];
                    for (const [key2, value2] of Object.entries(this.odata.recipies[key].input)) {
                        let unit_cost = this.getPrice(key2, this.selected_buy_price) * value2;
                        cost += unit_cost;
                        cost_breakdown.push({resource: this.resource_name(key2) + ' x ' + value2, cost: unit_cost.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 })});
                    }
                    
                    let sale = this.getSaleValue(key);
                    let gain = (sale[2] * 0.95 - cost);
                    let roi = (gain / cost * 100);
                    
                    gain = gain.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
                    if (sale[0] != sale[1]) {
                        gain += ' (' + (sale[0] * 0.95 - cost).toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 })
                              + ' ~ ' + (sale[1] * 0.95 - cost).toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + ')'
                    }
                    
                    let entry = {
                        id: key,
                        name: value.display_name,
                        cost: cost.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 }),
                        sale: sale[2].toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 }),
                        gain: gain,
                        roi: roi.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                        cost_breakdown: cost_breakdown,
                        icon: 'images/' + value.building + '.webp'
                    }
                
                    if (first_time) {
                        this.resources.push(entry)
                    } else {
                        for (let i = 0; i < this.resources.length; i++)
                            if (this.resources[i].id == key)
                                this.$set(this.resources, i, entry);
                    }
                }
            },
            async loadYAML() {
                await fetch('/resources.yaml', {
                    mode: 'cors',
                    method: 'GET',
                    headers: {
                        'Access-Control-Allow-Origin':'*',
                        'Content-Type': 'multipart/form-data'
                    }})
                    .then(res => res.blob())
                    .then(blob => blob.text())
                    .then(yamlAsString => {
                        this.odata = jsyaml.load(yamlAsString);
                        this.sources_loaded++;
                    })
                    .catch(err => console.log('yaml error:', err))                    
                if (this.sources_loaded == this.sources_to_load) this.buildTable(true);
            },
            async loadMarket() {
                 //await fetch("/market.json")
                 await fetch("https://us-west-2.aws.data.mongodb-api.com/app/mommarketreader-uqbem/endpoint/wholemarket")
                    .then(res => res.json())
                    .then(out => {
                        this.market = out.data;
                        
                        // get time of latest update, remove mongoDB types fields
                        let last_update = 0;
                        for (let i = 0; i < this.market.length; i++) {
                            let time = new Date(this.market[i].attributes.updatedAt);
                            if (time > last_update)
                                last_update = time;
                            for (const [key, value] of Object.entries(this.market[i].attributes)) {
                                if (typeof value === 'object')
                                    this.market[i].attributes[key] = value[Object.keys(value)[0]];
                            }
                        }
                        this.market_timestamp = last_update;
                        this.updateTimer()
                        this.sources_loaded++;
                     })
                    .catch(err => {
                        console.log('market error:', err);
                        this.market_timetext = 'failed to load.';
                        this.market_time_warning = true;
                    })
                if (this.sources_loaded == this.sources_to_load) this.buildTable(true);
            },
            getColor (roi) {
                if (roi == 0) return 'black'
                if (roi > 5) return 'green'
                if (roi < -5) return 'red'
                return 'darkgrey'
            },

	      },
	  });
	  

  </script>
</body>
</html>