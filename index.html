<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>Million on Mars Land Rush ROI Calculator</title>
  <link rel="shortcut icon" href="favicon.ico">

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="js-yaml.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">

  <style>
      .dusk {
          color: #c17e1f;
          font-weight: bold
      }
      .v-select-list .v-list-item {
        min-height: 0 !important;
      }
      .v-btn {
        text-transform:none !important;
      }
  </style>

</head>
<body>

  <div id="app">
    <v-app>
      <v-main>
    
    <div style="float: left">
      <v-menu offset-y>
        <template v-slot:activator="{ on, attrs }">
          <v-btn dark v-bind="attrs" v-on="on">
            <v-icon>mdi-menu</v-icon>
          </v-btn>
        </template>
        <v-list>
          <v-list-item v-for="(item, index) in menuitems" :key="index" @click="menuClick(index)">
            <v-list-item-title>{{ item.title }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>
    </div>
    
     <p class="text-center">
    This tool calculates the Dusk gain of various <a href="https://www.milliononmars.com/">Million on Mars</a> tasks.<br>It is independently developed and may not incorporate the latest game updates, do your own calculations before making major decisions!
</p>
    
    <v-container>
      <v-row>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="buy_price" label="Buy Price" v-on:change="changeSelect" v-model="selected_buy_price"></v-select>
          <v-tooltip color="#333" bottom>
            <template v-slot:activator="{ on, attrs }">
              <v-icon v-bind="attrs" v-on="on" small>
                mdi-help-circle-outline
              </v-icon>
            </template>
            <span>
                  <b>Price of resources to calculate build cost</b><br>
                  <b>Last Sold</b> - Last sale price on market<br>
                  <b>24H Avg</b> - Average of last 24hrs of sales<br>
                  <b>Split</b> - Halfway between Last Sold and 24H Avg<br>
                  <b>Lower</b> - Either Last Sold or 24H Avg, whichever is lower<br>
                  <b>Higher</b> - Either Last Sold or 24H Avg, whichever is higher<br>
            </span>
          </v-tooltip>
        </v-col>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="sell_price" label="Sell Price" v-on:change="changeSelect" v-model="selected_sell_price"></v-select>
          <v-tooltip color="#333" bottom>
            <template v-slot:activator="{ on, attrs }">
              <v-icon dark v-bind="attrs" v-on="on" small>
                mdi-help-circle-outline
              </v-icon>
            </template>
            <span>
                  <b>Sale price of resources generated by tasks</b><br>
                  <b>Last Sold</b> - Last sale price on market<br>
                  <b>24H Avg</b> - Average of last 24hrs of sales<br>
                  <b>Split</b> - Halfway between Last Sold and 24H Avg<br>
                  <b>Lower</b> - Either Last Sold or 24H Avg, whichever is lower<br>
                  <b>Higher</b> - Either Last Sold or 24H Avg, whichever is higher<br>
            </span>
          </v-tooltip>
        </v-col>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="power_source" label="Power Source" v-on:change="changeSelect" v-model="selected_power_source"></v-select>
          <v-tooltip color="#333" bottom>
            <template v-slot:activator="{ on, attrs }">
              <v-icon dark v-bind="attrs" v-on="on" small>
                mdi-help-circle-outline
              </v-icon>
            </template>
            <span>
                  <b>Cost of Power used in calculations</b><br>
                  <b>Market Price</b> (<span class="dusk">{{ power_market }}</span> per cell) - Cost of buying Full cell and selling Empty cell<br>
                  <b>Charge Power Cell</b> (<span class="dusk">{{ power_charge1 }}</span> per cell) - Stamina cost of charging a Power cell<br>
                  <b>Charge Power Cell III</b> (<span class="dusk">{{ power_charge3 }}</span> per cell) - Stamina cost of charging Power cells 3-for-2<br>
                  <b>1 Dusk per Cell Work Order</b> (<span class="dusk">{{ work_order1 }}</span> per cell) - 1.04 Dusk to charge cell<br>
                  <b>2 Dusk per Cell Work Order</b> (<span class="dusk">{{ work_order2 }}</span> per cell) - 2.08 Dusk to charge cell<br>
                  <b>3 Dusk per Cell Work Order</b> (<span class="dusk">{{ work_order3 }}</span> per cell) - 3.12 Dusk to charge cell<br>
                  Prices included 2% chance of cell breaking
            </span>
        </v-col>
        <v-col class="d-flex" cols="6" sm="3">
          <v-select :items="stamina_source" label="Stamina Source" v-on:change="changeSelect" v-model="selected_stamina_source"></v-select>
          <v-tooltip color="#333" bottom>
            <template v-slot:activator="{ on, attrs }">
              <v-icon v-bind="attrs" v-on="on" small>
                mdi-help-circle-outline
              </v-icon>
            </template>
            <span v-html="stamina_help_text"></span>
          </v-tooltip>
        </v-col>
      </v-row>
      <v-row dense>
        <v-col cols="24" sm="12">
            <v-chip-group column>
              <v-chip v-for="bldg in bldg_items" :key="bldg.id" :class="{black:bldg.disabled}" @click="filter(bldg.id)" >
                <img v-bind:src="bldg.img" :style="bldg.disabled ? 'opacity: 0.5' : ''" height="24" style="margin-right: 6px; vertical-align:middle"/>
                <span :style="bldg.disabled ? 'color: #aaa' : ''">{{ bldg.name }}</span>
              </v-chip>
              <v-chip @click="toggleAllBldgs">Toggle All</v-chip>
            </v-chip-group>
        </v-col>
      </v-row>
      <v-row dense>
        <v-col cols="4">
            <v-dialog v-model="level_dialog" persistent max-width="600px" @click:outside="closeLevelDialog">
                <template v-slot:activator="{ on, attrs }">
                  <v-btn color="gray" dark v-bind="attrs" v-on="on">
                    Filter by XP Level
                  </v-btn>
                  <span style="padding-left: 0.5em">{{ level_hide_count }} hidden</span>
                </template>
              <v-card>
                <v-card-title>
                  <span class="text-h5">Hide tasks above level...</span>
                </v-card-title>
                <v-card-text>
                  <v-container>
                    <v-row v-for="slider in level_sliders" :key="slider.id">
                      <v-col cols="12">
                        <v-slider :label="slider.name" v-model="slider.value" class="align-center" min="1" max="145" hide-details>
                            <template v-slot:append>
                              <v-text-field v-model="slider.value" class="mt-0 pt-0" hide-details single-line type="number" style="width: 60px"></v-text-field>
                            </template>
                        </v-slider>
                        <span class="small">{{ level_hides[slider.id] }} {{ slider.name }} taks hidden</span>
                      </v-col>
                    </v-row>
                  </v-container>
                </v-card-text>
                <v-card-actions>
                  <v-spacer></v-spacer>
                  <v-btn color="gray" dark @click="closeLevelDialog">Apply</v-btn>
                </v-card-actions>
              </v-card>
            </v-dialog>
            
        </v-col>
        <v-col cols="4">
          <v-dialog v-model="liquidity_dialog" persistent max-width="600px" @click:outside="closeLiquidityDialog">
              <template v-slot:activator="{ on, attrs }">
                <v-btn color="gray" dark v-bind="attrs" v-on="on">
                  Hide Low Volume
                </v-btn>
                <span style="padding-left: 0.5em">{{ liquidity_hide_count }} hidden</span>
              </template>
            <v-card>
              <v-card-title>
                <span>Hide tasks if primary output has a 24-hour sales volume less than...</span>
              </v-card-title>
              <v-card-text>
                <v-container>
                  <v-row>
                    <v-col cols="12">
                      <v-slider v-model="liquidity_slider" :tick-labels="liquidity_slider_labels" :max="4" step="1" ticks="always" tick-size="4">
                      </v-slider>
                    </v-col>
                  </v-row>
                </v-container>
              </v-card-text>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn color="gray" dark @click="closeLiquidityDialog">Apply</v-btn>
              </v-card-actions>
            </v-card>
          </v-dialog>
        </v-col>
        <v-col cols="3">
            <v-select :items="gain_mode" v-on:change="changeSelect" v-model="selected_gain_mode" dense></v-select>
        </v-col>
      </v-row>
      <v-row :class="{red:market_time_warning}" class="text-right" dense>
        <v-col class="text-right" cols="24" sm="12">
          Market data {{ market_timetext }}
        </v-col>
      </v-row>
    </v-container>
         
         
    
    <v-data-table :headers="headers" :items="filteredResources" :items-per-page="-1" class="elevation-1" :custom-sort="tableSort" dark>
    
      <template v-slot:item.name="{ item }">
        <img v-bind:src="item.icon" v-bind:title="item.icon_title" height="24" style="margin-right: 6px; vertical-align:middle"/>{{ item.name }}
      </template>
      
      <template v-slot:item.cost="props">
          <v-edit-dialog>
            {{ props.item.cost | localnum }}
            <template v-slot:input>
            <v-card style="border: 1px solid white;">
              <v-list dense color="grey darken-3" rounded>
                <v-list-item-title><b>{{props.item.name}}</b> : <span class="dusk">{{ props.item.cost | localnum}}</span></v-list-item-title>
                <small v-if="props.item.level_required" style="color: #99f">{{ props.item.level_required }}</small>
                <small v-if="props.item.day_text" style="color: #99f">{{ props.item.day_text }}</small>
                <v-divider></v-divider>
                <template v-for="(line, index) in props.item.cost_breakdown">
                    <v-list-item-content>
                    {{ line.resource }} : {{ line.cost }} <small v-if="line.unitcost">({{ line.unitcost }} each)</small>
                    </v-list-item-content>
                </template>
            </v-card>
            </template>
          </v-edit-dialog>
      </template>
      
      <template v-slot:item.sale="props">
          <v-edit-dialog>
            {{ props.item.sale | localnum }}
            <template v-slot:input>
            <v-card style="border: 1px solid white">
              <v-list dense color="grey darken-3" rounded>
                <v-list-item-title><b>{{props.item.name}}</b> : <span class="dusk">{{ props.item.sale | localnum }}</span></v-list-item-title>
                <v-divider></v-divider>
                <small v-if="props.item.output_speculative" style="color: #f99">Speculative Estimate</small>
                <template v-for="(line, index) in props.item.sale_breakdown">
                    <v-list-item-content>
                    {{ line.resource }} :  {{ line.value_txt }} <small v-if="line.unitcost">({{ line.unitcost }} each)</small>
                    </v-list-item-content>
                </template>
            </v-card>
            </template>
          </v-edit-dialog>
      </template>
      
      <template v-slot:item.gain="{ item }">
          <div v-html="item.gain"></div> 
      </template>
      
      <template v-slot:item.roi="{ item }">
        <v-chip :color="getColor(item.roi)">
          {{ item.roi | localnum }}%
        </v-chip>
      </template>
    </v-data-table>

<p></p>

  <p><img src="images/AbacusMonkey.png" width="64" style="float: left; margin-left: 1em; margin-right: 1em"> Created by digipedro. Images are Copyright Million on Mars Inc.<br/>Donations of WAX can be sent to <b>iamdigipedro</b><br/>Donations of BANANO can be sent to
	<a href="https://creeper.banano.cc/explorer/account/ban_3d6pzryts53tzk1u87yobfcrcwuiq11hhpj7oo8mapnodpkroc7dkqq8z8hc/history">
	ban_3d6pzryts53tzk1u87yobfcrcwuiq11hhpj7oo8mapnodpkroc7dkqq8z8hc
	</a>

      </v-main>
    </v-app>
  </div>



  <script>
      function localnum(num) {
          if (isNaN(num) || num === null)
              return "---";
          return num.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
      }
      
      const capitalize = (s) => {
        return s.charAt(0).toUpperCase() + s.slice(1)
      }
      
      const sumValues = obj => Object.values(obj).reduce((a, b) => a + b);
      
      const research_re = /research_([a-z]+)_([najem])/;
      const tools_re = /([a-z]+)_tools_([najem])/;
      
      const default_level_hides = {
                chemistry: 0,
                electrical: 0,
                fabrication: 0,
                'life science': 0,
                machining: 0,
                mining: 0,
                robotics: 0,
                scavenging: 0
            };
      
      
	  var vv = new Vue({
	    el: '#app',
		mounted:function() {
            this.loadYAML();
            this.loadMarket();
            
            // load user settings            
            for (i = 0; i < localStorage.length; i++) {
                let key = localStorage.key(i);
                let value = localStorage.getItem(key);
                if (key == 'selected_buy_price' && this.buy_price.includes(value))
                    this.selected_buy_price = value;
                if (key == 'selected_sell_price' && this.sell_price.includes(value))
                    this.selected_sell_price = value;
                if (key == 'selected_power_source' && this.power_source.includes(value))
                    this.selected_power_source = value;
                if (key == 'selected_stamina_source' && this.stamina_source.includes(value))
                    this.selected_stamina_source = value;
                if (key == 'selected_gain_mode' && this.gain_mode.includes(value))
                    this.selected_gain_mode = value;
                if (key == 'liquidity_slider')
                    this.liquidity_slider = value;
                if (key == 'bldg_hide')
                    this.bldg_hide = JSON.parse(value);
                if (key == 'levels') {
                    let level_set = JSON.parse(value);
                    for (const [key, value] of Object.entries(level_set)) {
                        let idx = this.level_sliders.findIndex(x => x.id === key);
                        this.level_sliders[idx].value = value;
                    }
                }
                this.setGainHeader();
            }
            
            setInterval(function() { this.updateTimer() }.bind(this), 30 * 1000 );
		},
	    vuetify: new Vuetify({
            theme: { dark: true },
        }),
	    data: {
            odata: {},
            market: {},
            sources_loaded: 0,
            sources_to_load: 2,
            buy_price: ['Last Sold', '24H Avg', 'Split', 'Lower', 'Higher'],
            selected_buy_price: 'Last Sold',
            sell_price: ['Last Sold', '24H Avg', 'Split', 'Lower', 'Higher'],
            selected_sell_price: 'Last Sold',
            power_source: ['Market Price', 'Charge Power Cell', 'Charge Power Cell III', '1 Dusk per Cell Work Order', '2 Dusk per Cell Work Order', '3 Dusk per Cell Work Order'],
            selected_power_source: 'Charge Power Cell',
            stamina_source: ['Eat Snack', 'Eat Meal', 'Eat Feast', 'Eat Mushroom Cake', 'Drink Coffee', 'Slava Ukraini', 'Drink Mushroom Tea', 'Job', 'Daily Ration'],
            stamina_help_text: '',
            selected_stamina_source: 'Eat Meal',
            level_dialog: false,
            level_sliders: [
                {id: 'chemistry', name: 'Chemistry', value: 145},
                {id: 'electrical', name: 'Electrical', value: 145},
                {id: 'fabrication', name: 'Fabrication', value: 145},
                {id: 'life science', name: 'Life Science', value: 145},
                {id: 'machining', name: 'Machining', value: 145},
                {id: 'mining', name: 'Mining', value: 145},
                {id: 'robotics', name: 'Robotics', value: 145},
                {id: 'scavenging', name: 'Scavenging', value: 145}
            ],
            level_hides: {...default_level_hides},                    
            level_hide_count: 0,
            liquidity_hide_count: 0,
            liquidity_dialog: false,
            liquidity_slider: 0,
            liquidity_slider_labels: ['All', '10', '100', '1000', '10000'],
            liquidity_slider_values: [0, 10, 100, 1000, 10000],
            gain_mode: ['Gain per Task', 'Gain per Power Cell', 'Gain per Stamina'],
            selected_gain_mode: 'Gain per Task',
            market_timestamp: 0,
            market_timetext: 'Loading...',
            market_time_warning: false,
            power_market: 1,
            power_charge1: 1,
            power_charge3: 1,
            work_order1: 1,
            work_order2: 2,
            work_order3: 3,
            user_settings: {},
            bldg_items: [],
            bldg_hide: [],
            cheapest_shard: {
                C: null,
                U: null,
                R: null,
                E: null,
                M: null,
                L: null,
            },
            headers: [
              { text: 'Name', align: 'start', value: 'name' },
              { text: 'Build Cost', value: 'cost' },
              { text: 'Sale Value', value: 'sale' },
              { text: 'Gain (After Fees)', value: 'gain' },
              { text: 'ROI (After Fees)', value: 'roi' },
            ],
            resources: [],
            menuitems: [
              { title: 'ROI Calculator', href: 'index.html'},
              { title: 'Price History', href: 'summary.html'},
              { title: 'Tools', href: 'tools.html'},
            ]
	    },
        filters: {
            localnum: function (num) { return localnum(num) },
            capitalize: function (text) { return capitalize(text) }
        },
        computed: {
            filteredResources() {
                let filteredTable = []
                for (i = 0; i < this.resources.length; i ++) {
                    if (this.resources[i].show)
                        filteredTable.push(this.resources[i])
                }
                return filteredTable;
            }
        },
        watch: {
            level_sliders: {
                handler(newValue, oldValue) {
                    this.countHiddenByLevel();
                },
                deep: true
            }
        },
	    methods: {
            toggleAllBldgs() {
                let mode = this.bldg_items[0].disabled;
                for (const [key, value] of Object.entries(this.bldg_items)) {
                    this.bldg_items[key].disabled = !mode
                }
                this.buildTable()
            },
            menuClick(index) {
               window.location.href = this.menuitems[index].href;
            },
            closeLevelDialog() {
                this.level_dialog = false;
                this.saveUserSettings()
                this.buildTable()
            },
            filter(id) {
                for (const [key, value] of Object.entries(this.bldg_items)) {
                    if (id == value.id)
                        this.bldg_items[key].disabled = !this.bldg_items[key].disabled
                }
                this.saveUserSettings()
                this.buildTable()
            },
            checkForFilter(id) {
                for (const [key, value] of Object.entries(this.bldg_items)) {
                    if (id == value.id)
                        return this.bldg_items[key].disabled;
                }
                return false;
            },
            tableSort(items, index, isDesc) {
                items.sort((a, b) => {
                    if (isDesc[0]) {
                        if ((typeof a[index] == 'number' && isNaN(a[index])) || (typeof a[index] == 'string' && a[index].includes('---')))
                          return -1;
                        if ((typeof a[index] == 'number' && isNaN(b[index])) || (typeof b[index] == 'string' && b[index].includes('---')))
                          return 1;
                        return parseFloat(a[index]) < parseFloat(b[index]) ? -1 : 1;
                    } else {
                        if ((typeof a[index] == 'number' && isNaN(a[index])) || (typeof a[index] == 'string' && a[index].includes('---')))
                            return 1;
                        if ((typeof a[index] == 'number' && isNaN(b[index])) || (typeof b[index] == 'string' && b[index].includes('---')))
                            return -1;
                        return parseFloat(a[index]) > parseFloat(b[index]) ? -1 : 1;
                    }
                });
                return items;
            },
            saveUserSettings() {
                localStorage.setItem('selected_buy_price', this.selected_buy_price);
                localStorage.setItem('selected_sell_price', this.selected_sell_price);
                localStorage.setItem('selected_power_source', this.selected_power_source);
                localStorage.setItem('selected_stamina_source', this.selected_stamina_source);
                localStorage.setItem('selected_gain_mode', this.selected_gain_mode);
                this.bldg_hide = []
                for (const [key, value] of Object.entries(this.bldg_items)) {
                    if (this.bldg_items[key].disabled)
                        this.bldg_hide.push(value.id)
                }
                localStorage.setItem('bldg_hide', JSON.stringify(this.bldg_hide));
                let levels = {}
                for (let i = 0; i < this.level_sliders.length; i++) {
                    levels[this.level_sliders[i].id] = this.level_sliders[i].value;
                }
                localStorage.setItem('levels', JSON.stringify(levels));
                localStorage.setItem('liquidity_slider', this.liquidity_slider);
            },
            changeSelect(id) {
                this.saveUserSettings();
                this.setGainHeader();
                this.buildTable();
            },
            setGainHeader() {
                if (this.selected_gain_mode == 'Gain per Power Cell')
                    this.headers[3].text = 'Gain / Power (After Fees)'
                else if (this.selected_gain_mode == 'Gain per Stamina')
                    this.headers[3].text = 'Gain / Stamina (After Fees)'
                else
                    this.headers[3].text = 'Gain / Task (After Fees)'
            },
            closeLiquidityDialog() {
                this.liquidity_dialog = false;
                this.saveUserSettings()
                this.buildTable()
            },
            countHiddenByLevel() {
                this.level_hides = {...default_level_hides}
                
                if (!('recipes' in this.odata))
                    return;
                
                for (const [key, value] of Object.entries(this.odata.recipes)) {
                    if ('level' in value) {
                        for (const [key2, value2] of Object.entries(value.level)) {
                            let idx = this.level_sliders.findIndex(x => x.id === key2);
                            if (value2 > this.level_sliders[idx].value) {
                                this.level_hides[key2]++
                            }
                        }
                    }
                }
                this.level_hide_count = sumValues(this.level_hides);
            },
            updateTimer() {
                if (this.market_timestamp == 0)
                    return;
                let tdiff = ((new Date()).getTime() - this.market_timestamp.getTime()) / 1000;
                if (tdiff < 60)
                    this.market_timetext = "updated < 1 min ago";
                else if (tdiff < 3600)
                    this.market_timetext = "updated " + Math.round(tdiff / 60) + " mins ago";
                else if (tdiff < 5400)
                    this.market_timetext = "updated 1 hour ago";
                else
                    this.market_timetext = "updated " + Math.round(tdiff / 3600) + " hours ago"
                this.market_time_warning = (tdiff > 5400);
            },
            getStaminaCost(method) {
                let food = this.getPrice('food', this.selected_buy_price);
                let water = this.getPrice('water', this.selected_buy_price);
                let waste = this.getPrice('waste', this.selected_sell_price);
                if (method == 'Eat Snack')
                    return (30 * food + 10 * water - 2 * waste) / 16;
                if (method == 'Eat Feast')
                    return (90 * food + 30 * water - 6 * waste) / 32;
                if (method == 'Eat Mushroom Cake')
                    return (this.getPrice('mushroom_cake', this.selected_buy_price) - 2.5 * waste - 10) / 18;
                if (method == 'Drink Coffee')
                    return this.getPrice('coffee_brewed', this.selected_buy_price) / 8;
                if (method == 'Slava Ukraini')
                    return (this.getPrice('coffee_brewed', this.selected_buy_price) - 2) / 10;
                if (method == 'Drink Mushroom Tea')
                    return (this.getPrice('mushroom_tea', this.selected_buy_price) - 7) / 15;
                if (method == 'Sunflower Seeds')
                    return (this.getPrice('sunflower_seeds_roasted', this.selected_buy_price) - 1.5 * waste) / 7.5;
                if (method == 'Sunflower Snack')
                    return (this.getPrice('sunflower_seed_snack', this.selected_buy_price) - 1.5 * waste) / 18;
                if (method == 'Job')
                    return 1.04;
                if (method == 'Daily Ration')
                    return 0;
                if (method == 'Martizen (C)')
                    return (60 * food + 20 * water - 2 * waste) / 21;
                if (method == 'Martizen (UC)')
                    return (60 * food + 20 * water - 2 * waste) / 22;
                if (method == 'Martizen (R)')
                    return (60 * food + 20 * water - 2 * waste) / 23;
                if (method == 'Martizen (E)')
                    return (60 * food + 20 * water - 2 * waste) / 25;
                // 'Eat Meal'
                return (60 * food + 20 * water - 4 * waste) / 24;
            },
            getPowerCost(source) {
                if (source == 'Market Price')
                    return ((this.getPrice('full_pc', this.selected_buy_price) - this.getPrice('empty_pc', this.selected_sell_price) * 0.95 ) / 20) * 0.98
                          + ((this.getPrice('full_pc', this.selected_buy_price) - this.getPrice('broken_pc', this.selected_sell_price) * 0.95) / 20) * 0.02;
                let broken_tax = (this.getPrice('empty_pc', this.selected_buy_price) - this.getPrice('broken_pc', this.selected_sell_price)) * 0.02;
                if (source == 'Charge Power Cell III')
                    return (this.getStaminaCost(this.selected_stamina_source) * 2 + broken_tax * 3) / 60
                if (source == '1 Dusk per Cell Work Order')
                    return (1.04 + broken_tax ) / 20
                if (source == '2 Dusk per Cell Work Order')
                    return (2.08 + broken_tax ) / 20
                if (source == '3 Dusk per Cell Work Order')
                    return (3.12 + broken_tax) / 20
                // 'Charge Power Cell'
                return (this.getStaminaCost(this.selected_stamina_source) + broken_tax) / 20
            },
            getCheapestShards(rarity) {
                if (this.cheapest_shard[rarity] == null) {
                    // build object once
                    let shard_name = { ...this.cheapest_shard };
                    const tradeable_shards = [
                        'shard_mining_rig_',
                        'shard_polar_workshop_',
                        'shard_solar_panel_',
                        'shard_rover_works_',
                        'shard_grindnbrew_',
                        'shard_3d_print_shop_',
                        'shard_chem_lab_',
                        'shard_sab_reactor_',
                        'shard_machine_shop_',
                        'shard_smelter_',
                        'shard_cad_',
                        'shard_water_filter_',
                        'shard_greenhouse_'
                    ];
                    for (let i = 0; i < this.market.length; i++) {
                        if (this.market[i].id.startsWith('shard_') && this.market[i].id.charAt(this.market[i].id.length - 2) == '_') {
                            if (tradeable_shards.includes(this.market[i].id.slice(0, -1))) {
                                let r = this.market[i].id.slice(-1);
                                let price = this.getPrice(this.market[i].id, this.selected_buy_price);
                                if (this.cheapest_shard[r] == null || price < this.cheapest_shard[r]) {
                                    this.cheapest_shard[r] = price;
                                    shard_name[r] = this.market[i].id
                                }
                            }
                        }
                    }
                    console.log('Cheapest Shards:', JSON.stringify(shard_name));
                    console.log('Cantina Coin I:', localnum(this.getPrice('cantina_coin')));
                }
                return this.cheapest_shard[rarity];
            },
            getPrice(id, type = 'Split') {                                
                if (id == 'power')
                    return this.getPowerCost(this.selected_power_source);
                if (id == 'stamina')
                    return this.getStaminaCost(this.selected_stamina_source);
                if (id.endsWith('_tools')) {
                    let value = this.getPrice(id + '_n', type) / 50;
                    if (!value)
                        value = this.getPrice(id + '_a', type) / 75;
                    if (!value)
                        value = this.getPrice(id + '_j', type) / 125;
                    return value;
                }
                if (id == 'dusk')
                    return 1;
                
                if (id == 'surveyor_coin')
                    return 45;
                if (id == 'cantina_coin')
                    return (this.getPrice('power') * 20
                           + this.getPrice('aluminum_plate', type)
                           + this.getPrice('metal_bits', type) * 15
                           + this.getPrice('stamina') * 2
                           + this.getPrice('machining_tools', type) * 2) / 15;
                if (id == 'resource_credit')
                    return 0.5;
                
                if (id.startsWith('bazaar_coin_')) {
                    let rarity = id.slice(-1);
                    if (rarity == 'C' || rarity == 'U')
                        return this.getCheapestShards(rarity) * 4;
                    if (rarity == 'R')
                        return this.getCheapestShards(rarity) * 5;
                    if (rarity == 'E')
                        return this.getCheapestShards(rarity) * 6;
                    if (rarity == 'L')
                        return this.getCheapestShards(rarity) * 8;
                    if (rarity == 'M')
                        return this.getCheapestShards(rarity) * 10;
                }

                    
                for (let i = 0; i < this.market.length; i++) {
                    if (this.market[i].id == id) {
                        if (type == 'Last Sold')
                            return this.market[i].attributes.lastSoldPrice
                        if (type == '24H Avg')
                            return this.market[i].attributes.averageDaySoldPrice
                        if (type == 'Split')
                            return ((this.market[i].attributes.lastSoldPrice + this.market[i].attributes.averageDaySoldPrice) / 2);
                        if (type == 'Lower')
                            return Math.min(this.market[i].attributes.lastSoldPrice, this.market[i].attributes.averageDaySoldPrice);
                        if (type == 'Higher')
                            return Math.max(this.market[i].attributes.lastSoldPrice, this.market[i].attributes.averageDaySoldPrice);
                    }
                }
                
                // items not in market but may be added in future
                
                if (id == 'sunflower')
                    return 0;
                if (id == 'research_machining_e')
                    return 0;
                
                console.log('ERROR: No price for', id);
                
                return NaN;
            },
            resourceName(id) {
                if (this.odata.resources[id])
                    return this.odata.resources[id].display_name
                
                let match = research_re.exec(id);
                if (match != null) {
                    let name = ' ' + capitalize(match[1]) + ' Research';
                    if (match[2] == 'n')
                        name = 'Novice' + name;
                    else if (match[2] == 'a')
                        name = ((id.slice(-2) == 'ar') ? 'Artisan' : 'Apprentice') + name;
                    else if (match[2] == 'j')
                        name = 'Journeyman' + name;
                    else if (match[2] == 'e')
                        name = 'Expert' + name;
                    else if (match[2] == 'm')
                        name = 'Master' + name;
                    return name;
                }
                
                match = tools_re.exec(id);
                if (match != null) {
                    let name = ' ' + capitalize(match[1]) + ' Tools';
                    if (match[2] == 'n')
                        name = 'Novice' + name;
                    else if (match[2] == 'a')
                        name = ((id.slice(-2) == 'ar') ? 'Artisan' : 'Apprentice') + name;
                    else if (match[2] == 'j')
                        name = 'Journeyman' + name;
                    else if (match[2] == 'e')
                        name = 'Expert' + name;
                    else if (match[2] == 'm')
                        name = 'Master' + name;
                    return name;
                }

                return capitalize(id.replaceAll('_', ' '));
            },
            resourceVolume(id) {
                for (let i = 0; i < this.market.length; i++) {
                    if (this.market[i].id == id) {                        
                        return this.market[i].attributes.lastDayVolume
                    }
                }
                return 0;
            },
            building_name(id) {
                return (id === undefined) ? '' : this.odata.buildings[id].display_name
            },
            processLoot(key2, value2, items, sale) {
                let min_gain = null;
                let max_gain = null;
                let repeat = 1;
                for (let i = 0; i < value2.length; i++) {
                    let item = Object.keys(value2[i])[0];
                    let probs = [0, 0, 0];
                    let price = 1;
                    if (item == 'repeat') {
                        repeat = value2[i][item];
                        continue;
                    } else if (item == 'percent' || item == 'lootlist' || item == 'lootset') {
                        let percent = 1.0;
                        if (item == 'percent') {
                            percent = value2[i][item] / 100;
                            i = i + 1;
                        }
                        let r_items = {};
                        let r_sale = { min: 0, max: 0, avg: 0, gain: 0 };
                        key2 = Object.keys(value2[i])[0];
                        this.processLoot(key2, value2[i][key2], r_items, r_sale);

                        probs = [percent, r_sale.min, r_sale.max];
                        
                        for (const [i_id, i_values] of Object.entries(r_items)) {
                            if (items.hasOwnProperty(i_id)) {
                                items[i_id].number += i_values.number * percent * repeat;
                                items[i_id].price += i_values.price * percent * repeat;
                            } else {
                                items[i_id] = i_values;
                                items[i_id].number = items[i_id].number * percent * repeat;
                                items[i_id].price = items[i_id].price * percent * repeat;
                            }
                        }
                    } else {
                        probs = value2[i][item];
                        price = this.getPrice(item, this.selected_sell_price);
                    
                        let avg_yield = (probs[1] + probs[2]) / 2;
                    
                        if (items.hasOwnProperty(item)) {
                            items[item].number += avg_yield * probs[0] * repeat;
                            items[item].price += price * avg_yield * probs[0] * repeat;
                        } else {
                            items[item] = {
                                number: avg_yield * probs[0] * repeat,
                                name: this.resourceName(item),
                                price: price * avg_yield * probs[0] * repeat
                            }
                        }
                    }
                    
                    let market_fee = (item == 'dusk' || item == 'cantina_coin') ? 1.0 : 0.95
                    
                    if (probs[0] == 1) {
                        if (min_gain == null)
                            min_gain = 0;
                        min_gain += price * probs[1] * repeat * market_fee;
                    } else if (key2 == 'lootset') {
                        if (min_gain == null) {
                            min_gain = price * probs[1] * repeat * market_fee;
                        } else {
                            let test = price * probs[1] * repeat * market_fee;
                            min_gain = (test < min_gain) ? test : min_gain;
                        }
                    }

                    if (probs[0] == 1) {
                        if (max_gain == null)
                            max_gain = 0;
                        max_gain += price * probs[2] * repeat * market_fee;
                    } else {
                        if (max_gain == null) {
                            max_gain = price * probs[2] * repeat * market_fee;
                        } else {
                            let test = price * probs[2] * repeat * market_fee;
                            if (key2 == 'lootset')
                                max_gain = (test > max_gain) ? test : max_gain;
                            else
                                max_gain += test;
                        }
                    }
                }
                // divide min and max by 0.95 because we already include market fee here but not in simple method
                sale.min = min_gain / 0.95;
                sale.max = max_gain / 0.95;
            },
            expandDay(day) {
                if (day == 'mon')
                    return 'Monday'
                if (day == 'tue')
                    return 'Tuesday'
                if (day == 'wed')
                    return 'Wednesday'
                if (day == 'thu')
                    return 'Thursday'
                if (day == 'fri')
                    return 'Friday'
                if (day == 'sat')
                    return 'Saturday'
                if (day == 'sun')
                    return 'Sunday'
                return ''
            },
            buildTable(first_time = false) {
                this.liquidity_hide_count = 0;
                for (const [key, value] of Object.entries(this.odata.recipes)) {  
                    let cost = 0;
                    let cost_breakdown = [];
                    let power_used = 0;
                    let stamins_used = 0;
                    for (const [key2, value2] of Object.entries(this.odata.recipes[key].input)) {
                        let unit_cost = this.getPrice(key2, this.selected_buy_price) * value2;
                        cost += unit_cost;
                        cost_breakdown.push( {resource: this.resourceName(key2) + ' x ' + value2, cost: localnum(unit_cost), unitcost: ( value2 > 1) ? localnum(this.getPrice(key2, this.selected_buy_price)) : null} );
                        if (key2 == "power")
                            power_used = value2;
                        if (key2 == "stamina")
                            stamina_used = value2;
                    }
                    
                    let sale_breakdown = [];
                    let sale = { min: 0, max: 0, avg: 0, gain: 0}
                    let market_fee_offset = [0, 0];
                    for (const [key2, value2] of Object.entries(this.odata.recipes[key].output)) {
                        if (key2 == 'lootset' || key2 == 'lootlist') {
                            let items = {};
                            
                            this.processLoot(key2, value2, items, sale);
                            
                            sale.gain = 0;
                            sale.avg = 0;

                            for (const [aitem, values] of Object.entries(items)) {
                                let titem = {
                                    resource: values.name + ' x ' + localnum(values.number),
                                    value_num: values.price,
                                    value_txt: localnum(values.price),
                                    volume: this.resourceVolume(aitem)
                                }
                                sale.avg += values.price;
                                if (aitem == 'dusk') {
                                    sale.gain += values.price
                                } else {
                                    sale.gain += values.price * 0.95;
                                    titem.unitcost = localnum(this.getPrice(aitem, this.selected_sell_price));
                                }
                                sale_breakdown.push(titem);
                            }
                        } else {
                            let item = {}
                            if (Array.isArray(value2)) {
                                sale.min += this.getPrice(key2, this.selected_sell_price) * value2[0];
                                sale.max += this.getPrice(key2, this.selected_sell_price) * value2[1];
                                sale.avg += this.getPrice(key2, this.selected_sell_price) * value2[2];
                                if (key2 == 'dusk' || key2 == 'cantina_coin') {
                                    sale.gain += this.getPrice(key2, this.selected_sell_price) * value2[2];
                                    market_fee_offset[0] += this.getPrice(key2, this.selected_sell_price) * value2[0] * 0.05;
                                    market_fee_offset[1] += this.getPrice(key2, this.selected_sell_price) * value2[1] * 0.05;
                                } else
                                    sale.gain += this.getPrice(key2, this.selected_sell_price) * value2[2] * 0.95;
                                item.resource = this.resourceName(key2) + ' x ' + value2[2];
                                item.value_num = this.getPrice(key2, this.selected_sell_price) * value2[2];
                                item.value_txt = localnum(item.value_num);
                                if (value2[2] > 1 && key2 != 'dusk')
                                    item.unitcost = localnum(this.getPrice(key2, this.selected_sell_price));
                            } else {
                                let avg_price = this.getPrice(key2, this.selected_sell_price) * value2;
                                sale.min += avg_price;
                                sale.max += avg_price;
                                sale.avg += avg_price;
                                if (key2 == 'dusk' || key2 == 'cantina_coin')
                                    sale.gain += avg_price
                                else
                                    sale.gain += avg_price * 0.95;
                                item.resource = this.resourceName(key2) + ' x ' + value2;
                                item.value_num = avg_price;
                                item.value_txt = localnum(avg_price);
                                if (value2 > 1 && key2 != 'dusk')
                                    item.unitcost = localnum(this.getPrice(key2, this.selected_sell_price));
                            }
                            item.volume = this.resourceVolume(key2);
                            sale_breakdown.push(item);
                        }
                    }
                    let gain = (sale.gain - cost);
                    let roi = (gain / cost * 100);
                    
                    let divisor = 1;
                    if (this.selected_gain_mode == "Gain per Power Cell")
                        divisor = (power_used / 20);
                    else if (this.selected_gain_mode == "Gain per Stamina")
                        divisor = stamina_used;
                        
                    if (divisor == 0)
                        gain = '---'
                    else {
                        gain = localnum(gain / divisor);
                        if (sale.min != sale.max) {
                            gain += ' (' + localnum((sale.min * 0.95 - cost + market_fee_offset[0]) / divisor)
                                  + ' ~ ' + localnum((sale.max * 0.95 - cost + market_fee_offset[1]) / divisor) + ')'
                        }
                    }
                    
                    // building filter
                    let show = true;
                    // liquidity filter
                    if (this.liquidity_slider > 0) {
                        for (i = 0; i < sale_breakdown.length; i++) {
                             if (sale_breakdown[i].resource.startsWith("Dusk"))
                                continue;
                            if ((sale_breakdown[i].value_num * 2) >= sale.gain && sale_breakdown[i].volume < this.liquidity_slider_values[this.liquidity_slider]) {
                                show = false;
                                this.liquidity_hide_count++;
                            }
                        }
                    }
                    if (show)
                        show = !('building' in value && this.checkForFilter(value.building));
                    // level filter
                    if (show && 'level' in value) {
                        for (const [key2, value2] of Object.entries(value.level)) {
                            let idx = this.level_sliders.findIndex(x => x.id === key2);
                            if (value2 > this.level_sliders[idx].value) {
                                show = false;
                            }
                        }
                    }
                    
                    let entry = {
                        id: key,
                        name: value.display_name,
                        cost: cost,
                        sale: sale.avg,
                        gain: gain,
                        roi: roi,
                        cost_breakdown: cost_breakdown,
                        sale_breakdown: sale_breakdown,
                        output_speculative: this.odata.recipes[key].output_speculative,
                        icon: 'images/' + value.building + '.webp',
                        icon_title: this.building_name(value.building),
                        show: show
                    }
                    
                    if (value.level) {
                        let level_text = '';
                        for (const [level_name, level_num] of Object.entries(value.level)) {
                            level_text += capitalize(level_name) + ' Level ' + level_num + ', '
                        }
                        entry.level_required = level_text.slice(0, -2);
                    }
                    
                    if (value.day) {
                        if (Array.isArray(value.day)) {
                            let day_text = '';
                            for (let i = 0; i < value.day.length; i++) {
                                day_text += this.expandDay(value.day[i]) + ', '
                            }
                            entry.day_text = day_text.slice(0, -2);
                        } else {
                            entry.day_text = this.expandDay(value.day);
                        }
                    }
                
                    if (first_time) {
                        this.resources.push(entry);
                        this.countHiddenByLevel();
                    } else {
                        for (let i = 0; i < this.resources.length; i++)
                            if (this.resources[i].id == key)
                                this.$set(this.resources, i, entry);
                    }
                }
                this.stamina_help_text = '<b>Eat Snack</b> - <span class="dusk">' + localnum(this.getStaminaCost('Eat Snack')) + '</span><br>'
                                        +'<b>Eat Meal</b> - <span class="dusk">' + localnum(this.getStaminaCost('Eat Meal')) + '</span> avg<br>'
                                        +'<b>Eat Feast</b> - <span class="dusk">' + localnum(this.getStaminaCost('Eat Feast')) + '</span> avg<br>'
                                        +'<b>Drink Coffee</b> - <span class="dusk">' + localnum(this.getStaminaCost('Drink Coffee')) + '</span> avg<br>'
                                        +'<b>Slava Ukraini</b> - <span class="dusk">' + localnum(this.getStaminaCost('Slava Ukraini')) + '</span> avg<br>'
                                        +'<b>Roasted Sun Seeds</b>  - <span class="dusk">' + localnum(this.getStaminaCost('Sunflower Seeds')) + '</span> avg<br>'
                                        +'<b>Sunflower Snack</b>  - <span class="dusk">' + localnum(this.getStaminaCost('Sunflower Snack')) + '</span> avg<br>'
                                        +'<b>Drink Mushroom Tea</b> - <span class="dusk">' + localnum(this.getStaminaCost('Drink Mushroom Tea')) + '</span> avg<br>'
                                        +'<b>Eat Mushroom Cake</b> - <span class="dusk">' + localnum(this.getStaminaCost('Eat Mushroom Cake')) + '</span> avg<br>'
                                        +'<b>Martizen (UC)</b> - <span class="dusk">' + localnum(this.getStaminaCost('Martizen (UC)')) + '</span> avg<br>'
                                        +'<b>Job</b> - <span class="dusk">1.040</span><br>'
                                        +'<b>Eat Ration</b> - <span class="dusk"> 0.000</span><br>'
                this.power_market = localnum(this.getPowerCost('Market Price') * 20);
                this.power_charge1 = localnum(this.getPowerCost('Charge Power Cell') * 20);
                this.power_charge3 = localnum(this.getPowerCost('Charge Power Cell III') * 20);
                this.work_order1 = localnum(this.getPowerCost('1 Dusk per Cell Work Order') * 20);
                this.work_order2 = localnum(this.getPowerCost('2 Dusk per Cell Work Order') * 20);
                this.work_order3 = localnum(this.getPowerCost('3 Dusk per Cell Work Order') * 20);
            },
            async loadYAML() {
                await fetch('resources.yaml', {
                    mode: 'cors',
                    method: 'GET',
                    headers: {
                        'Access-Control-Allow-Origin':'*',
                        'Content-Type': 'multipart/form-data'
                    }})
                    .then(res => res.blob())
                    .then(blob => blob.text())
                    .then(yamlAsString => {
                        this.odata = jsyaml.load(yamlAsString);
                        for (const [key, value] of Object.entries(this.odata.buildings)) {
                            this.bldg_items.push({
                                id: key,
                                name: value.display_name,
                                img: 'images/' + key + '.webp',
                                disabled: this.bldg_hide.includes(key)
                            });
                        }
                        this.bldg_select = this.bldg_items;
                        this.sources_loaded++;
                    })
                    .catch(err => console.log('yaml error:', err))                    
                if (this.sources_loaded == this.sources_to_load) this.buildTable(true);
            },
            async loadMarket() {
                 //await fetch("market.json")
                 await fetch("https://us-west-2.aws.data.mongodb-api.com/app/mommarketreader-uqbem/endpoint/wholemarket2")
                    .then(res => res.json())
                    .then(out => {
                        this.market = out.data;
                        
                        let last_update = 0;
                        for (let i = 0; i < this.market.length; i++) {
                            // get time of latest update
                            let time = new Date(this.market[i].attributes.updatedAt);
                            if (time > last_update)
                                last_update = time;
                            // set 0 day average price to last price
                            if (this.market[i].attributes.averageDaySoldPrice == 0)
                                this.market[i].attributes.averageDaySoldPrice = this.market[i].attributes.lastSoldPrice;
                        }
                        this.market_timestamp = last_update;
                        this.updateTimer()
                        this.sources_loaded++;
                     })
                    .catch(err => {
                        console.log('market error:', err);
                        this.market_timetext = 'failed to load.';
                        this.market_time_warning = true;
                    })
                if (this.sources_loaded == this.sources_to_load) this.buildTable(true);
            },
            getColor (roi) {
                if (roi == 0) return 'black'
                if (roi > 5) return 'green'
                if (roi < -5) return 'red'
                return 'darkgrey'
            },

	      },
	  });
	  

  </script>
</body>
</html>